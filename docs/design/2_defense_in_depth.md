# AI 면접관 신뢰성 강화를 위한 심층 방어(Defense-in-Depth) 설계

## 1. 개요

AI 면접관의 안정성과 목적성을 보장하기 위해, 면접과 관련 없거나 부적절한 사용자의 요청에 체계적으로 대응하는 다층적 방어(Defense-in-Depth) 아키텍처를 도입합니다. 이 설계는 단일 방어선에 의존하는 대신, 여러 단계의 검증 및 제어 메커니즘을 통해 시스템의 견고함을 극대화하는 것을 목표로 합니다.

---

## 2. 방어 계층 (Defense Layers)

### 1단계: 선제적 입력 관리 (Proactive Input Management)

사용자 입력이 시스템의 핵심 로직에 도달하기 전에 의도를 분석하고 유해성을 검증하는 **게이트키퍼(Gatekeeper)** 역할입니다.

#### **전략 1: 라우터-디스패처 패턴 (Router-Dispatcher Pattern)**

모든 사용자 메시지는 면접 로직을 직접 실행하는 대신, 의도를 분류하는 `router` 노드를 먼저 통과합니다.

-   **구현**:
    1.  `InterviewGraph`의 진입점(`START`)을 `router` 노드로 설정합니다.
    2.  `router` 노드는 LLM을 사용하여 사용자 입력의 의도를 다음과 같이 분류합니다.
        -   `interview_related`: 면접과 관련된 정상적인 입력
        -   `out_of_scope`: 면접과 관련 없는 질문 (예: "오늘 날씨 어때?")
        -   `toxic`: 공격적이거나 부적절한 언어
    3.  LLM의 출력을 `{"next": "interview_related"}` 와 같이 **구조화된 형식(Structured Output)**으로 강제하여 라우팅 결정의 신뢰성을 100% 보장합니다.
    4.  `add_conditional_edges`를 사용하여 `router`의 분류 결과에 따라 워크플로우를 분기합니다.
        -   `interview_related` -> `supervisor` (핵심 면접 로직)
        -   `out_of_scope` | `toxic` -> `rejection_node` (거절 응답 로직)

-   **거절 노드 (`rejection_node`)**:
    -   미리 정의된 정중하지만 단호한 응답을 생성합니다.
    -   **응답 예시**: "저는 AI 역량 면접을 진행하도록 설계되었습니다. 면접과 관련된 대화에 집중해 주시기 바랍니다."
    -   이후 `supervisor`로 제어권을 넘겨 이전 질문을 반복하거나 면접을 이어갑니다.

#### **전략 2: 전문화된 가드레일 (Specialized Guardrails)**

특히 유해성(Toxicity) 검증은 일반 LLM보다 특화된 도구를 사용하는 것이 더 효율적이고 안정적입니다.

-   **구현**: `Guardrails AI` 또는 `Layerup Security`와 같은 전문 라이브러리를 도입합니다.
-   `router` 노드 **앞단**에 `safety_check` 노드를 배치하여, 욕설이나 공격적인 언어를 최우선으로 필터링하고 즉시 `rejection_node`로 보냅니다.

### 2단계: 워크플로우 제어 (Workflow Control)

1단계 방어선을 통과하더라도, 대화의 전체 흐름을 제어하는 `supervisor`가 2차 방어선 역할을 수행합니다.

#### **전략: 슈퍼바이저 프롬프트 강화**

`supervisorNode`의 시스템 프롬프트에 대화의 주제를 제어하는 규칙을 명시적으로 추가합니다.

-   **구현**: `supervisor`의 프롬프트에 다음과 같은 규칙을 추가합니다.
    > **추가 규칙**: "만약 사용자의 최신 답변이 현재 면접 단계나 질문과 명백히 관련이 없다고 판단되면, 다른 에이전트를 호출하기 전에 먼저 `rejection_node`를 호출하여 대화의 초점을 바로잡아라."

-   **역할**: 이 규칙을 통해 `supervisor`는 대화의 '지휘자'로서, 대화 흐름이 궤도를 이탈했을 때 이를 능동적으로 감지하고 수정하는 최종적인 제어권을 갖게 됩니다.

---

## 3. 기대 효과

이러한 심층 방어 설계를 통해 다음과 같은 효과를 기대할 수 있습니다.

-   **신뢰성 향상**: 면접관이 주어진 역할(면접 진행)을 벗어나지 않고 일관된 행동을 보장합니다.
-   **안정성 증대**: 부적절한 입력으로 인해 발생할 수 있는 시스템 오류나 예기치 않은 동작을 원천적으로 차단합니다.
-   **자원 효율성**: 처리할 가치가 없는 요청에 LLM 호출 등 불필요한 컴퓨팅 자원을 낭비하는 것을 방지합니다.
-   **사용자 경험 개선**: AI가 명확한 목적을 가지고 상호작용함으로써 사용자에게 더 전문적이고 신뢰감 있는 인상을 줍니다.